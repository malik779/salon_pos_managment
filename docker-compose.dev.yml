version: "3.9"

x-dotnet-service: &dotnet-service
  environment:
    ASPNETCORE_ENVIRONMENT: Development
    ConnectionStrings__Default: "Server=sqlserver,1433;Database=app;User ID=sa;Password=P@ssword12345!;TrustServerCertificate=True;"
    Redis__ConnectionString: redis:6379
    RabbitMQ__HostName: rabbitmq
  depends_on:
    - sqlserver
    - redis
    - rabbitmq

services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: salon_sql
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "P@ssword12345!"
    ports:
      - "14333:1433"
    volumes:
      - sql_data:/var/opt/mssql

  redis:
    image: redis:7-alpine
    container_name: salon_redis
    ports:
      - "6379:6379"

  rabbitmq:
    image: rabbitmq:3-management
    container_name: salon_rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: salon
      RABBITMQ_DEFAULT_PASS: salonpass

  identity-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./services/Identity/Dockerfile
    container_name: identity_service
    ports:
      - "5001:8080"

  branch-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./services/Branch/Dockerfile
    container_name: branch_service
    ports:
      - "5003:8080"

  catalog-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./services/Catalog/Dockerfile
    container_name: catalog_service
    ports:
      - "5004:8080"

  booking-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./services/Booking/Dockerfile
    container_name: booking_service
    ports:
      - "5002:8080"

  pos-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./services/POS/Dockerfile
    container_name: pos_service
    ports:
      - "5005:8080"

  payments-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./services/Payments/Dockerfile
    container_name: payments_service
    ports:
      - "5006:8080"

  staff-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./services/Staff/Dockerfile
    container_name: staff_service
    ports:
      - "5007:8080"

  client-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./services/Client/Dockerfile
    container_name: client_service
    ports:
      - "5008:8080"

  notifications-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./services/Notifications/Dockerfile
    container_name: notifications_service
    ports:
      - "5009:8080"

  reports-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./services/Reports/Dockerfile
    container_name: reports_service
    ports:
      - "5010:8080"

  sync-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./services/Sync/Dockerfile
    container_name: sync_service
    ports:
      - "5011:8080"

  audit-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./services/Audit/Dockerfile
    container_name: audit_service
    ports:
      - "5012:8080"

  gateway-service:
    build:
      context: .
      dockerfile: ./services/Gateway/Dockerfile
    container_name: gateway_service
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      FRONTEND_API_BASE_URL: "http://localhost:5000"
      FRONTEND_SIGNALR_HUB_URL: "http://localhost:5000/hubs/updates"
      FRONTEND_ENVIRONMENT: "development"
    ports:
      - "5000:8080"
    depends_on:
      - identity-service
      - branch-service
      - catalog-service
      - booking-service
      - pos-service
      - payments-service
      - staff-service
      - client-service
      - notifications-service
      - reports-service
      - sync-service
      - audit-service

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: salon_frontend
    environment:
      API_BASE_URL: "http://localhost:5000"
      SIGNALR_HUB_URL: "http://localhost:5000/hubs/updates"
      ENVIRONMENT: "development"
      VERSION: "1.0.0"
    ports:
      - "4200:80"
    depends_on:
      - gateway-service
    restart: unless-stopped

volumes:
  sql_data:
