x-dotnet-service: &dotnet-service
  environment:
    ASPNETCORE_ENVIRONMENT: Development
    ConnectionStrings__Default: "Server=sqlserver,1433;Database=app;User ID=sa;Password=P@ssword12345!;TrustServerCertificate=True;"
    Redis__ConnectionString: redis:6379
    RabbitMQ__HostName: rabbitmq
  depends_on:
    - sqlserver
    - redis
    - rabbitmq

services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: salon_sql
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: "P@ssword12345!"
    ports:
      - "14333:1433"
    volumes:
      - sql_data:/var/opt/mssql

  redis:
    image: redis:7-alpine
    container_name: salon_redis
    ports:
      - "6379:6379"

  rabbitmq:
    image: rabbitmq:3-management
    container_name: salon_rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: salon
      RABBITMQ_DEFAULT_PASS: salonpass

  identity-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./Identity/Dockerfile
    container_name: identity_service
    ports:
      - "5011:8080"

  branch-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./Branch/Dockerfile
    container_name: branch_service
    ports:
      - "5013:8080"

  catalog-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./Catalog/Dockerfile
    container_name: catalog_service
    ports:
      - "5014:8080"

  booking-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./Booking/Dockerfile
    container_name: booking_service
    ports:
      - "5012:8080"

  pos-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./POS/Dockerfile
    container_name: pos_service
    ports:
      - "5015:8080"

  payments-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./Payments/Dockerfile
    container_name: payments_service
    ports:
      - "5016:8080"

  staff-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./Staff/Dockerfile
    container_name: staff_service
    ports:
      - "5017:8080"

  client-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./Client/Dockerfile
    container_name: client_service
    ports:
      - "5018:8080"

  notifications-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./Notifications/Dockerfile
    container_name: notifications_service
    ports:
      - "5019:8080"

  reports-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./Reports/Dockerfile
    container_name: reports_service
    ports:
      - "5010:8080"

  sync-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./Sync/Dockerfile
    container_name: sync_service
    ports:
      - "5021:8080"

  audit-service:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: ./Audit/Dockerfile
    container_name: audit_service
    ports:
      - "5022:8080"

  gateway-service:
    build:
      context: .
      dockerfile: ./Gateway/Dockerfile
    container_name: gateway_service
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      # These are used by the /api/config endpoint for frontend configuration
      FRONTEND_API_BASE_URL: "http://localhost:5000"
      FRONTEND_SIGNALR_HUB_URL: "http://localhost:5000/hubs/updates"
      FRONTEND_ENVIRONMENT: "production"
    ports:
      - "5000:8080"
    depends_on:
      - identity-service
      - branch-service
      - catalog-service
      - booking-service
      - pos-service
      - payments-service
      - staff-service
      - client-service
      - notifications-service
      - reports-service
      - sync-service
      - audit-service

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: salon_frontend
    environment:
      # These URLs must be accessible from the browser, not from inside Docker
      # Override these when deploying to production with your actual domain
      API_BASE_URL: "http://localhost:5000"
      SIGNALR_HUB_URL: "http://localhost:5000/hubs/updates"
      ENVIRONMENT: "production"
      VERSION: "1.0.0"
    ports:
      - "4300:80"
    depends_on:
      - gateway-service
    restart: unless-stopped

volumes:
  sql_data:
